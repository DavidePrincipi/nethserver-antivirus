#!/bin/bash

FOUND=0

# Check if a mirror is reachable and start freshclam before running clamd
# to avoid daemon startup errors..
for MIRROR in `sed -n '/^DatabaseMirror/ s/DatabaseMirror // p' /etc/freshclam.conf`; do
    if nc -z $MIRROR 80; then
	echo "Updating virus signature database.."
	/usr/bin/freshclam --quiet
	if [ $? -eq 0 ]; then
	    FOUND=1
	fi
	break;
    else
	echo Unreachable mirror ${MIRROR}
    fi
done

if [ ${FOUND} -eq 0 ]; then 
    echo "Creating empty clamav signatures DB.."
    echo "Eicar-Test-Signature:0:0:58354f2150254041505b345c505a58353428505e2937434329377d2445494341522d5354414e444152442d414e544956495255532d544553542d46494c452124482b482a" >/var/clamav/eicar.ndb
fi

exit 0
